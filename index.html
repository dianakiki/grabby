<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --toy-size: 95px; /* Игрушки стали больше */
            --claw-size: 115px;
            --panel-h: 170px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #1a0825; display: flex; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }

        .machine-wrapper { width: 100vw; height: 100%; display: flex; flex-direction: column; background: #2c0e3a; position: relative; }

        /* СТАРТОВЫЙ ЭКРАН */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c0e3a; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .logo-img { width: 70%; max-width: 260px; height: auto; margin-bottom: 20px; animation: floating 2s ease-in-out infinite; }
        .btn-start-img { width: 120px; height: auto; background: none; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-start-img img { width: 100%; height: auto; }
        .btn-start-img:active { transform: scale(0.9); }
        .version-text { color: rgba(255, 255, 255, 0.4); font-size: 12px; margin-top: 20px; }

        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        #start-screen.hidden { opacity: 0; visibility: hidden; }

        /* UI */
        .ui-top {
            position: absolute; top: env(safe-area-inset-top, 10px);
            left: 0; width: 100%; padding: 0 15px;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .btn-back { width: 40px; height: 40px; background: url('image/left_button.png') no-repeat center/contain; border: none; cursor: pointer; }
        .score-board { background: rgba(0, 0, 0, 0.5); padding: 5px 12px; border-radius: 10px; color: #fff; border: 2px solid #ff00ff; font-size: 14px; }

        /* ИГРОВАЯ ЗОНА */
        .game-area { flex: 1; position: relative; background: url('image/background.png') no-repeat center/cover; background-color: #2c0e3a; overflow: hidden; }

        /* Внутренний короб (игрушки не выходят за эти рамки) */
        .toys-inner-box {
            position: absolute; bottom: 0; left: 15%; right: 15%; height: 160px; pointer-events: none;
        }

        /* КЛЕШНЯ */
        .claw-system {
            position: absolute;
            top: -450px;
            left: 50%;
            width: var(--claw-size);
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            transition: transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95), left 0.1s linear;
        }

        .claw-rope {
            width: 18px;
            height: 500px;
            background: url('image/chain.png') repeat-y center/contain;
        }

        .claw-hand {
            width: var(--claw-size);
            height: var(--claw-size);
            background: url('image/claw_open.png') no-repeat center/contain;
            margin-top: -5px;
        }
        .claw-hand.closed { background-image: url('image/claw_close.png'); }

        /* Игрушки */
        .prize {
            position: absolute;
            width: var(--toy-size);
            height: var(--toy-size);
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 5;
            bottom: 25px; /* Немного приподнял над нижним краем */
            transition: bottom 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95), left 1s ease-in-out;
        }

        /* УПРАВЛЕНИЕ */
        .controls { height: var(--panel-h); background: #1a0825; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom, 15px); }
        .joystick { width: 90px; height: 110px; background: url('image/levir.png') no-repeat center/contain; touch-action: none; }
        .joystick.left { background-image: url('image/levir_left.png'); }
        .joystick.right { background-image: url('image/levir_right.png'); }
        .btn-drop { width: 105px; height: 105px; background: url('image/button_drop.png') no-repeat center/contain; border: none; cursor: pointer; }

        /* ПОБЕДА */
        #win-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); z-index: 200; pointer-events: none;
        }
        .win-img { width: 85%; max-width: 300px; animation: popIn 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.49); }

        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes falling { to { transform: translateY(800px) rotate(45deg); opacity: 0; } }
    </style>
</head>
<body>

<div id="start-screen">
    <img src="image/logo.png" alt="Logo" class="logo-img">
    <button class="btn-start-img" onclick="startGame()">
        <img src="image/button_start.png" alt="Start">
    </button>
        <div class="version-text">v.1.0.2.6</div>
</div>

<div class="machine-wrapper">
    <div class="ui-top">
        <button class="btn-back" onclick="backToMenu()"></button>
        <div class="score-board">PRIZES: <span id="score">0</span>/7</div>
    </div>

    <div id="win-overlay">
        <img src="image/you_win.png" alt="YOU WIN" class="win-img">
    </div>

    <div class="game-area" id="area">
        <div class="toys-inner-box" id="toys-box"></div>
        <div class="claw-system" id="claw">
            <div class="claw-rope"></div>
            <div class="claw-hand" id="hand"></div>
        </div>
    </div>

    <div class="controls">
        <div class="joystick" id="joy"></div>
        <button class="btn-drop" id="dropBtn"></button>
    </div>
</div>

<script>
    // Инициализация Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.expand(); // Расширить на весь экран

    // Массив файлов изображений игрушек
    const toyFiles = ['cute_toy_1.png', 'cute_toy_2.png', 'cute_toy_3.png', 'cute_toy_4.png', 'cute_toy_5.png', 'cute_toy_6.png', 'cute_toy_7.png'];
    // Начальная позиция клешни по X, флаг занятости, счет
    let clawX = window.innerWidth / 2;
    let isBusy = false;
    let score = 0;

    // Получение элементов DOM
    const claw = document.getElementById('claw');
    const hand = document.getElementById('hand');
    const area = document.getElementById('area');
    const toysBox = document.getElementById('toys-box');
    const joy = document.getElementById('joy');
    const scoreText = document.getElementById('score');
    const winOverlay = document.getElementById('win-overlay');

    // Функция спавна игрушек в коробе
    function spawn() {
        // Очищаем короб от предыдущих игрушек
        toysBox.innerHTML = '';
        // Сбрасываем счет, скрываем победный экран
        score = 0;
        scoreText.innerText = score;
        winOverlay.style.display = 'none';
        
        // Ширина короба, ширина игрушки
        const boxWidth = toysBox.offsetWidth;
        const toyW = 90; 

        // Для каждой игрушки
        toyFiles.forEach((img, i) => {
            // Создаем div для игрушки, устанавливаем класс и изображение
            const t = document.createElement('div');
            t.className = 'prize';
            t.style.backgroundImage = `url('image/${img}')`;
            
            // РАНДОМНОЕ РАСПОЛОЖЕНИЕ ВНУТРИ КОРОБА
            // Рассчитываем случайную позицию X, чтобы они не вылезали за края
            const randomX = Math.random() * (boxWidth - toyW);
            const randomY = Math.random() * 20; // Небольшой разброс по высоте

            t.style.left = randomX + 'px';
            t.style.bottom = (10 + randomY) + 'px';
            // Добавляем игрушку в короб
            toysBox.appendChild(t);
        });
    }

    // Функция начала игры
    function startGame() {
        // Скрываем стартовый экран, спавним игрушки, вибрация
        document.getElementById('start-screen').classList.add('hidden');
        spawn();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
    }

    // Функция возврата в меню
    function backToMenu() {
        document.getElementById('start-screen').classList.remove('hidden');
    }

    // Асинхронная функция падения клешни
    async function dropClaw() {
        if (isBusy) return; // Если клешня уже занята, выходим
        isBusy = true; // Устанавливаем флаг занятости
        hand.classList.remove('closed'); // Открываем клешню
        
        const dropDist = area.offsetHeight - 185; // Расстояние падения
        claw.style.transition = "transform 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95)";
        claw.style.transform = `translateX(-50%) translateY(${dropDist}px)`; // Падаем вниз

        await new Promise(r => setTimeout(r, 1200)); // Ждем завершения анимации падения

        const prizes = document.querySelectorAll('.prize');
        let caught = null;
        let closestDist = Infinity;
        prizes.forEach(p => {
            const pRect = p.getBoundingClientRect();
            const hRect = hand.getBoundingClientRect();
            const dist = Math.abs((pRect.left + pRect.width / 2) - (hRect.left + hRect.width / 2));
            // Запоминаем игрушку, которая находится максимально близко к центру клешни
            if (dist < 45 && dist < closestDist) {
                closestDist = dist;
                caught = p;
            }
        }); // Проверяем, поймали ли игрушку

        if (caught) {
            const areaRect = area.getBoundingClientRect();
            const toyRect = caught.getBoundingClientRect();
            const bottomInArea = areaRect.bottom - toyRect.bottom;
            const leftInArea = toyRect.left - areaRect.left;

            caught.style.transition = "bottom 1.2s cubic-bezier(0.45, 0.05, 0.55, 0.95), left 1s ease-in-out";
            caught.style.bottom = bottomInArea + "px";
            caught.style.left = leftInArea + "px";
            area.appendChild(caught);
        }

        hand.classList.add('closed'); // Закрываем клешню
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); // Вибрация
        await new Promise(r => setTimeout(r, 400)); // Ждем

        // ПОДЪЕМ
        claw.style.transform = `translateX(-50%) translateY(0px)`; // Поднимаемся вверх
        if (caught) {
            caught.style.bottom = (area.offsetHeight - 145) + "px"; // Игрушка плавно поднимается вместе с клешней
        }
        await new Promise(r => setTimeout(r, 1300)); // Ждем подъема

        if (caught) {
            // ОТВОЗ В ДЫРУ
            claw.style.transition = "left 1s ease-in-out, transform 0.1s";
            clawX = 60; claw.style.left = "60px"; // Перемещаем клешню влево
            caught.style.left = "25px"; // Игрушка тоже
            await new Promise(r => setTimeout(r, 1050));

            hand.classList.remove('closed'); // Открываем клешню
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); // Успешная вибрация
            
            caught.style.transition = "none";
            caught.style.animation = "falling 0.8s forwards"; // Анимация падения
            
            score++; // Увеличиваем счет
            scoreText.innerText = score;

            setTimeout(() => {
                caught.remove(); // Удаляем игрушку
                console.log('Remaining toys:', document.querySelectorAll('.prize').length);
                // ПРОВЕРКА: Если игрушек больше нет в контейнере
                if (document.querySelectorAll('.prize').length === 0) {
                    triggerWin(); // Победа
                }
            }, 800);
        }
        isBusy = false; // Снимаем флаг занятости
    }

    // Функция победы
    function triggerWin() {
        console.log('Triggering win');
        winOverlay.style.display = 'flex'; // Показываем оверлей победы
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#ff00ff', '#ffffff', '#ff0055']
        }); // Запускаем конфетти
    }

    // Назначаем функцию падения на кнопку
    document.getElementById('dropBtn').onclick = dropClaw;

    // Обработчик клика на оверлей победы для перезапуска
    winOverlay.onclick = () => {
        winOverlay.style.display = 'none';
        spawn();
    };

    // Функция обработки джойстика
    function handleJoy(x) {
        if (isBusy) return; // Если занято, выходим
        const rect = joy.getBoundingClientRect();
        const mid = rect.left + rect.width / 2;
        if (x < mid - 15) {
            clawX -= 8;
            joy.className = 'joystick left'; // Влево
        } else if (x > mid + 15) {
            clawX += 8;
            joy.className = 'joystick right'; // Вправо
        }
        
        const limit = area.offsetWidth;
        const minX = 40;
        const maxX = limit - 40;

        if (clawX < minX) clawX = minX;
        if (clawX > maxX) clawX = maxX; // Ограничения позиции
        claw.style.left = clawX + 'px'; // Обновляем позицию клешни
    }

    // Обработчики событий джойстика
    joy.addEventListener('touchstart', (e) => { e.preventDefault(); }); // Предотвращаем стандартное поведение
    window.addEventListener('touchend', () => { joy.className = 'joystick'; }); // Сбрасываем класс джойстика
    window.addEventListener('touchmove', (e) => { handleJoy(e.touches[0].clientX); }); // Обработка движения джойстика

</script>
</body>
</html>
